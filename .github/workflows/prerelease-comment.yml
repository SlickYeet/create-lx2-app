# Adapted from create-t3-app.
name: Write Beta Release comment

on:
  workflow_run:
    workflows: ["Release - Beta"]
    types:
      - completed

jobs:
  comment:
    if: |
      github.repository_owner == 'lx2dev' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    name: Write comment to the PR
    steps:
      - name: "Comment on PR"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const artifacts = response.data?.artifacts || [];
            console.log('Artifacts found:', artifacts.map(a => a.name));

            let matched = false;
            for (const artifact of artifacts) {
              const match = /^npm-package-create-lx2-app@(.*?)-pr-(\d+)$/.exec(artifact.name);
              if (match) {
                require('fs').appendFileSync(
                  process.env.GITHUB_ENV,
                  `BETA_PACKAGE_VERSION=${match[1]}\nWORKFLOW_RUN_PR=${match[2]}\nWORKFLOW_RUN_ID=${context.payload.workflow_run.id}\n`
                );
                matched = true;
                console.log(`Matched artifact ${artifact.name}: PR=${match[2]}, version=${match[1]}`);
                break;
              }
            }

            if (!matched) {
              console.log('No matching artifact found; WORKFLOW_RUN_PR not set.');
            }

      - name: "Comment on PR with Link"
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ env.WORKFLOW_RUN_PR }}
          message: |
            A new prerelease is available for testing:

            ```sh
            pnpm create lx2-app@${{ env.BETA_PACKAGE_VERSION }}
            ```

      - name: "Remove the autorelease label once published"
        if: env.WORKFLOW_RUN_PR != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = process.env.WORKFLOW_RUN_PR;
            if (!pr) {
              console.log('WORKFLOW_RUN_PR is not set; skipping label removal.');
              return;
            }

            console.log(`Removing 'ðŸš€ autorelease' from PR ${pr}`);
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(pr),
              name: 'ðŸš€ autorelease',
            });